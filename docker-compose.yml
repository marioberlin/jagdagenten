# Docker Compose for Jagd-Agenten Development Services
#
# Usage:
#   Start services:   docker compose up -d
#   Stop services:    docker compose down
#   View logs:        docker compose logs -f postgres
#   Reset data:       docker compose down -v

services:
  postgres:
    image: postgres:16-alpine
    container_name: jagdagenten-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: jagdagenten
      POSTGRES_PASSWORD: jagdagenten_dev
      POSTGRES_DB: jagdagenten
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./server/sql:/docker-entrypoint-initdb.d:ro
    networks:
      - jagd-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U jagdagenten -d jagdagenten" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # Optional: Redis for distributed features (WebSocket scaling, caching)
  redis:
    image: redis:7-alpine
    container_name: jagdagenten-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - jagd-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # AI Agent Runtime Container
  # Pre-warmed container for executing AI agents in isolated environments
  jagd-runtime:
    build:
      context: ./server/container
      dockerfile: Dockerfile
    container_name: jagdagenten-runtime
    restart: unless-stopped
    volumes:
      # Mount sandbox directory for file operations
      - jagd_sandboxes:/sandboxes:rw
      # Mount /tmp for local development fallback
      - /tmp/jagd-sandboxes:/tmp/jagd-sandboxes:rw
    environment:
      JAGD_RUNTIME_MODE: pool
      JAGD_RUNTIME_PORT: 8080
      JAGD_MAX_EXECUTION_TIME: 300000
      JAGD_MAX_MEMORY_MB: 512
      JAGD_LOG_LEVEL: info
      VITE_REQUIRE_AUTH: "true"
    ports:
      - "8081:8080" # Expose runtime API
    networks:
      - jagd-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: [ "CMD", "curl", "-sf", "http://localhost:8080/health" ]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 3

  # Video Rendering Server (optional)
  video-runtime:
    build:
      context: ./server/container
      dockerfile: Dockerfile.video
    container_name: jagdagenten-video
    restart: unless-stopped
    volumes:
      - video_renders:/data/renders:rw
      - video_assets:/data/assets:rw
      - video_temp:/data/temp:rw
    environment:
      VIDEO_PORT: 8082
      VIDEO_OUTPUT_DIR: /data/renders
      VIDEO_ASSET_DIR: /data/assets
      VIDEO_TEMP_DIR: /data/temp
      VIDEO_MAX_CONCURRENT_RENDERS: 4
      VIDEO_DEFAULT_CODEC: h264
      VIDEO_DEFAULT_CRF: 18
      VIDEO_MAX_DURATION: 3600
      VIDEO_LOG_LEVEL: info
      DATABASE_URL: postgresql://jagdagenten:jagdagenten_dev@postgres:5432/jagdagenten
      REDIS_URL: redis://redis:6379
      NATS_URL: nats://nats:4222
    ports:
      - "8082:8082"
    networks:
      - jagd-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M
    healthcheck:
      test: [ "CMD", "curl", "-sf", "http://localhost:8082/health" ]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 3

  # NATS: High-performance messaging for A2A agents
  nats:
    image: nats:2.10-alpine
    container_name: jagdagenten-nats
    command: [ "--js", "--sd", "/data", "-m", "8222" ]
    restart: unless-stopped
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats_data:/data
    networks:
      - jagd-network
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz" ]
      interval: 5s
      timeout: 3s
      retries: 3

networks:
  jagd-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  nats_data:
    driver: local
  jagd_sandboxes:
    driver: local
  video_renders:
    driver: local
  video_assets:
    driver: local
  video_temp:
    driver: local
