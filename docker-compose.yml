# Docker Compose for LiquidCrypto Development Services
#
# Usage:
#   Start services:   docker compose up -d
#   Stop services:    docker compose down
#   View logs:        docker compose logs -f postgres
#   Reset data:       docker compose down -v

services:
  postgres:
    image: postgres:16-alpine
    container_name: liquidcrypto-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: liquidcrypto
      POSTGRES_PASSWORD: liquidcrypto_dev
      POSTGRES_DB: liquidcrypto
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./server/sql:/docker-entrypoint-initdb.d:ro
    networks:
      - liquid-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U liquidcrypto -d liquidcrypto" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # Optional: Redis for distributed features (WebSocket scaling, caching)
  redis:
    image: redis:7-alpine
    container_name: liquidcrypto-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - liquid-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # AI Agent Runtime Container
  # Pre-warmed container for executing AI agents in isolated environments
  liquid-runtime:
    build:
      context: ./server/container
      dockerfile: Dockerfile
    container_name: liquidcrypto-runtime
    restart: unless-stopped
    volumes:
      # Mount sandbox directory for file operations
      - liquid_sandboxes:/sandboxes:rw
      # Mount /tmp for local development fallback
      - /tmp/liquid-sandboxes:/tmp/liquid-sandboxes:rw
    environment:
      LIQUID_RUNTIME_MODE: pool
      LIQUID_RUNTIME_PORT: 8080
      LIQUID_MAX_EXECUTION_TIME: 300000
      LIQUID_MAX_MEMORY_MB: 512
      LIQUID_LOG_LEVEL: info
    ports:
      - "8081:8080" # Expose runtime API
    networks:
      - liquid-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: [ "CMD", "curl", "-sf", "http://localhost:8080/health" ]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 3

  # A2A Video: Remotion-compatible Video Rendering Server
  # FFmpeg-based video processing for AI agents
  video-runtime:
    build:
      context: ./server/container
      dockerfile: Dockerfile.video
    container_name: liquidcrypto-video
    restart: unless-stopped
    volumes:
      # Video outputs and assets
      - video_renders:/data/renders:rw
      - video_assets:/data/assets:rw
      - video_temp:/data/temp:rw
    environment:
      VIDEO_PORT: 8082
      VIDEO_OUTPUT_DIR: /data/renders
      VIDEO_ASSET_DIR: /data/assets
      VIDEO_TEMP_DIR: /data/temp
      VIDEO_MAX_CONCURRENT_RENDERS: 4
      VIDEO_DEFAULT_CODEC: h264
      VIDEO_DEFAULT_CRF: 18
      VIDEO_MAX_DURATION: 3600
      VIDEO_LOG_LEVEL: info
      DATABASE_URL: postgresql://liquidcrypto:liquidcrypto_dev@postgres:5432/liquidcrypto
      REDIS_URL: redis://redis:6379
      NATS_URL: nats://nats:4222
    ports:
      - "8082:8082" # Video API
    networks:
      - liquid-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M
    healthcheck:
      test: [ "CMD", "curl", "-sf", "http://localhost:8082/health" ]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 3

  # NATS: High-performance messaging for A2A agents and real-time events
  # Enables pub/sub with wildcards, work queues, and back-pressure support
  nats:
    image: nats:2.10-alpine
    container_name: liquidcrypto-nats
    command: [ "--js", "--sd", "/data", "-m", "8222" ]
    restart: unless-stopped
    ports:
      - "4222:4222" # Client connections
      - "8222:8222" # HTTP monitoring UI
    volumes:
      - nats_data:/data
    networks:
      - liquid-network
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz" ]
      interval: 5s
      timeout: 3s
      retries: 3

networks:
  liquid-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  nats_data:
    driver: local
  liquid_sandboxes:
    driver: local
  video_renders:
    driver: local
  video_assets:
    driver: local
  video_temp:
    driver: local
