# =============================================================================
# LiquidCrypto Frontend Docker Image
# Multi-stage build: Bun builds â†’ Caddy serves
#
# Build: docker build -f Dockerfile.frontend -t liquidcrypto-frontend .
# Run:   docker run -p 80:80 -p 443:443 liquidcrypto-frontend
# =============================================================================

# Stage 1: Build with Bun
FROM oven/bun:1 AS builder

WORKDIR /app

# Copy package files first for cache efficiency
COPY package.json bun.lock ./

# Copy workspace packages
COPY packages/ packages/

# Create minimal server package.json (just enough to satisfy workspace resolution)
RUN mkdir -p server && echo '{"name":"server","private":true}' > server/package.json

# Remove server from workspaces (we don't need server deps for frontend build)
# Use bun to manipulate JSON (jq not available in Debian-based image)
RUN bun -e "const p = await Bun.file('package.json').json(); p.workspaces = p.workspaces.filter(w => w !== 'server'); await Bun.write('package.json', JSON.stringify(p, null, 2));"

# Install dependencies (ignore failures for packages not needed for frontend)
RUN bun install || true

# Copy source files (after install to leverage cache)
COPY src/ src/
COPY public/ public/
COPY index.html vite.config.ts tsconfig.json tsconfig.node.json tailwind.config.js ./

# Copy server source files needed for type imports (tRPC router types)
COPY server/src/ server/src/
COPY server/tsconfig.json server/

# Build arguments for Vite environment variables
ARG VITE_GOOGLE_CLIENT_ID
ARG VITE_GOOGLE_API_KEY
ARG VITE_GOOGLE_MAPS_API_KEY
ARG VITE_GOOGLE_PLACES_API_KEY
ARG VITE_GOOGLE_MASTER_TEMPLATE_ID
ARG VITE_REQUIRE_AUTH=true

# Set environment variables for build
ENV VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
ENV VITE_GOOGLE_API_KEY=${VITE_GOOGLE_API_KEY}
ENV VITE_GOOGLE_MAPS_API_KEY=${VITE_GOOGLE_MAPS_API_KEY}
ENV VITE_GOOGLE_PLACES_API_KEY=${VITE_GOOGLE_PLACES_API_KEY}
ENV VITE_GOOGLE_MASTER_TEMPLATE_ID=${VITE_GOOGLE_MASTER_TEMPLATE_ID}
ENV VITE_REQUIRE_AUTH=${VITE_REQUIRE_AUTH}

# Build the frontend
RUN bun run build

# Stage 2: Serve with Caddy
FROM caddy:2-alpine

# Copy built files from builder stage
COPY --from=builder /app/dist /srv

# Copy Caddyfile (will be overwritten by volume in prod if needed)
COPY Caddyfile /etc/caddy/Caddyfile

# Expose ports
EXPOSE 80 443

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget -q --spider http://localhost/health || exit 1
