# Caddyfile for LiquidCrypto - Blue-Green Deployment
# Automatic HTTPS enabled for liquid-os.app

liquid-os.app, www.liquid-os.app {
    # Compression
    encode gzip

    # Cache static assets
    @static {
        path *.js *.css *.png *.jpg *.svg *.woff2 *.ico
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # API reverse proxy - routes to healthy backend
    # Both blue and green run on port 3000 internally (each container has its own network namespace)
    handle /api/* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
            health_interval 10s
            health_timeout 5s
        }
    }

    # WebSocket upgrade support
    handle /ws/* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
        }
    }

    # A2A agent endpoints
    handle /agents/* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
        }
    }

    # Health check endpoints
    handle /health* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
        }
    }

    # .well-known endpoints (for A2A discovery)
    handle /.well-known/* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
        }
    }

    # Remote A2A agent proxies (mirrors vite.config.ts dev proxies for production)
    handle_path /remote-a2a/* {
        rewrite * /api/v1/a2a/636a315d-a83a-4308-b9c2-2d1a6ba590ee{uri}
        reverse_proxy https://wr-demo.showheroes.com {
            header_up Host wr-demo.showheroes.com
            header_up Authorization "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjYjc3ZWNlYS0wZGQ3LTRmMDUtYjAwMy0yNDcwNzVkMTdjODkiLCJhZ2VudF9pZCI6IjYzNmEzMTVkLWE4M2EtNDMwOC1iOWMyLTJkMWE2YmE1OTBlZSIsIm1vZGUiOiJjb252ZXJzYXRpb24iLCJzY29wZSI6ImxpbWl0ZWQiLCJ0b2tlbl90eXBlIjoiYWdlbnQiLCJleHAiOjE5MjYzMzUzNzR9.4XwjmQW6NJxLH55KgDtsBxcfDsY2WRmg_-9yNmUd1B4"
            transport http {
                tls
            }
        }
    }

    handle_path /remote-oneflow/* {
        rewrite * /api/v1/a2a/1806dcb3-93ef-4b5f-8796-a6464e289066{uri}
        reverse_proxy https://wr-demo.showheroes.com {
            header_up Host wr-demo.showheroes.com
            header_up Authorization "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI0N2IxODUzOC0yNGI2LTRmOTQtOTU3My1kYTA4MmVkMGYyOWUiLCJhZ2VudF9pZCI6IjE4MDZkY2IzLTkzZWYtNGI1Zi04Nzk2LWE2NDY0ZTI4OTA2NiIsIm1vZGUiOiJjb252ZXJzYXRpb24iLCJzY29wZSI6ImxpbWl0ZWQiLCJ0b2tlbl90eXBlIjoiYWdlbnQiLCJleHAiOjE5MjY3OTA2NzJ9.ZTgv0CL2JrS0NOZztDZQgB2a8I7NW-Uud5MihIk_PoQ"
            transport http {
                tls
            }
        }
    }

    handle_path /remote-wr-demo/* {
        rewrite * /api/v1/a2a/42d2b311-9932-4533-a976-12c36c9dca52{uri}
        reverse_proxy https://wr-demo.showheroes.com {
            header_up Host wr-demo.showheroes.com
            header_up Authorization "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkZTllMjYxYy1jYWY4LTRhMGUtYjUyYS1lZjI2N2M0YjU0MjAiLCJhZ2VudF9pZCI6IjQyZDJiMzExLTk5MzItNDUzMy1hOTc2LTEyYzM2YzlkY2E1MiIsIm1vZGUiOiJjb252ZXJzYXRpb24iLCJzY29wZSI6ImxpbWl0ZWQiLCJ0b2tlbl90eXBlIjoiYWdlbnQiLCJleHAiOjE5MjcwOTk3NDN9.sJA-g54OqBpYujtzmagPbcwzDi4_V0YOvCoG8t7fhZU"
            transport http {
                tls
            }
        }
    }

    # Video render service - strip /video prefix before forwarding
    handle /video/* {
        uri strip_prefix /video
        reverse_proxy video-runtime:8082 {
            health_uri /health
            health_interval 10s
            health_timeout 5s
        }
    }

    # SPA fallback - serve static files and index.html for all other routes
    handle {
        root * /srv
        try_files {path} /index.html
        file_server
    }
}
