# Caddyfile for LiquidCrypto - Blue-Green Deployment
# Automatic HTTPS enabled for liquid-os.app

liquid-os.app, www.liquid-os.app {
    # Serve frontend static files
    root * /srv
    file_server
    
    # API reverse proxy - routes to healthy backend
    # Both blue and green run on port 3000 internally (each container has its own network namespace)
    handle /api/* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
            health_interval 10s
            health_timeout 5s
        }
    }
    
    # WebSocket upgrade support
    handle /ws/* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
        }
    }
    
    # A2A agent endpoints
    handle /agents/* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
        }
    }
    
    # Health check endpoints
    handle /health* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
        }
    }
    
    # .well-known endpoints (for A2A discovery)
    handle /.well-known/* {
        reverse_proxy backend-blue:3000 backend-green:3000 {
            lb_policy first
            health_uri /health
        }
    }

    # Video render service
    handle /video/* {
        reverse_proxy video-runtime:8082 {
            health_uri /health
            health_interval 10s
            health_timeout 5s
        }
    }

    # SPA fallback - serve index.html for all other routes
    try_files {path} /index.html
    
    # Compression
    encode gzip
    
    # Cache static assets
    @static {
        path *.js *.css *.png *.jpg *.svg *.woff2 *.ico
    }
    header @static Cache-Control "public, max-age=31536000, immutable"
}
